---
import Layout from "@/layouts/Layout.astro";
import { RecipeListView } from "@/components/recipes";
import { RecipeService } from "@/lib/services/recipe.service";
import { TagsService } from "@/lib/services/tags.service";
import { UnitsService } from "@/lib/services/units.service";
import { createSupabaseServerInstance } from "@/db/supabase.client";

export const prerender = false;

// Optional: Fetch initial data server-side for better performance
let initialData;
let initialTags;
let initialUnits;

try {
  // Get authenticated user
  const user = Astro.locals.user;
  
  if (user) {
    // Create Supabase client
    const supabase = createSupabaseServerInstance({
      cookies: Astro.cookies,
      headers: Astro.request.headers,
    });

    // Create service instances
    const recipeService = new RecipeService(supabase);
    const tagsService = new TagsService(supabase);
    const unitsService = new UnitsService(supabase);

    // Fetch recipes directly from service
    const recipes = await recipeService.listRecipes(user.id, {
      page: 1,
      limit: 20,
    });
    
    initialData = {
      success: true,
      data: recipes.data,
      pagination: recipes.pagination
    };

    // Fetch tags directly from service
    const tags = await tagsService.listTags();
    initialTags = tags;

    // Fetch units directly from service
    const units = await unitsService.listUnits();
    initialUnits = units;
  }
} catch (error) {
  console.error('Failed to fetch initial data:', error);
  // Continue without initial data - component will fetch client-side
}
---

<Layout title="Przepisy - Foodnager">
  <RecipeListView 
    client:load
    initialData={initialData}
    initialTags={initialTags}
    initialUnits={initialUnits}
  />
</Layout>


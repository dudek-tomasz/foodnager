---
import Layout from "@/layouts/Layout.astro";
import { RecipeDetailsView } from "@/components/recipe-details";
import { RecipeService } from "@/lib/services/recipe.service";
import { createSupabaseServerInstance } from "@/db/supabase.client";

export const prerender = false;

// Parse recipe ID from URL params
const { id } = Astro.params;
const recipeId = id ? parseInt(id, 10) : null;

// Parse query params
const from = Astro.url.searchParams.get("from") || undefined;
const matchScoreParam = Astro.url.searchParams.get("matchScore");
const matchScore = matchScoreParam ? parseFloat(matchScoreParam) : undefined;

// Validate recipe ID
if (!recipeId || isNaN(recipeId)) {
  return Astro.redirect("/recipes");
}

// Optional: Fetch recipe title for SEO (server-side)
let pageTitle = "Przepis - Foodnager";
try {
  // Get authenticated user
  const user = Astro.locals.user;

  if (user) {
    // Create Supabase client
    const supabase = createSupabaseServerInstance({
      cookies: Astro.cookies,
      headers: Astro.request.headers,
    });

    // Create service instance
    const recipeService = new RecipeService(supabase);

    // Fetch recipe directly from service
    const recipe = await recipeService.getRecipeById(user.id, recipeId);
    pageTitle = `${recipe.title} - Foodnager`;
  }
} catch (error) {
  console.error("Failed to fetch recipe title for SEO:", error);
  // Continue with default title
}
---

<Layout title={pageTitle}>
  <RecipeDetailsView client:load recipeId={recipeId} from={from} matchScore={matchScore} />
</Layout>

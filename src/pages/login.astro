---
/**
 * Login Page
 * 
 * Authentication page using AuthLayout and LoginForm component.
 * Features:
 * - Server-side rendering with session check
 * - Redirects logged-in users to /fridge
 * - Clean, centered design without navigation
 * - Query param support for redirect after login
 * 
 * Following auth-spec.md:
 * - Uses Astro.locals.user populated by middleware
 * - Public route (accessible without auth)
 * - Redirects authenticated users away
 */

import AuthLayout from "@/layouts/AuthLayout.astro";
import LoginForm from "@/components/auth/LoginForm";

export const prerender = false;

// Check if user is already logged in (populated by middleware)
const user = Astro.locals.user;

// If user is already authenticated, redirect to fridge
// Middleware also handles this, but double-check for safety
if (user) {
  return Astro.redirect("/fridge");
}

// Get redirect URL from query params (fallback to /fridge)
const redirectTo = Astro.url.searchParams.get("redirect") || "/fridge";

// Check for error/success messages in query params
const verified = Astro.url.searchParams.get("verified") === "true";
const resetSuccess = Astro.url.searchParams.get("reset") === "success";
const sessionExpired = Astro.url.searchParams.get("session_expired") === "true";
---

<AuthLayout title="Logowanie - Foodnager" description="Zaloguj siÄ™ do swojego konta Foodnager">
  <div class="space-y-6">
    <!-- Logo Section -->
    <div class="text-center space-y-2">
      <div class="flex justify-center">
        <span class="text-6xl">ğŸ³</span>
      </div>
      <h1 class="text-3xl font-bold tracking-tight text-neutral-900 dark:text-neutral-100">Foodnager</h1>
      <p class="text-neutral-600 dark:text-neutral-300">
        ZarzÄ…dzaj przepisami i wirtualnÄ… lodÃ³wkÄ…
      </p>
    </div>

    <!-- Success/Info Messages -->
    {verified && (
      <div class="p-3 text-sm text-green-700 bg-green-50 dark:bg-green-950/30 dark:text-green-400 rounded-lg border border-green-200 dark:border-green-900">
        âœ… Email zweryfikowany pomyÅ›lnie! MoÅ¼esz siÄ™ teraz zalogowaÄ‡.
      </div>
    )}
    
    {resetSuccess && (
      <div class="p-3 text-sm text-green-700 bg-green-50 dark:bg-green-950/30 dark:text-green-400 rounded-lg border border-green-200 dark:border-green-900">
        âœ… HasÅ‚o zostaÅ‚o zmienione. Zaloguj siÄ™ uÅ¼ywajÄ…c nowego hasÅ‚a.
      </div>
    )}
    
    {sessionExpired && (
      <div class="p-3 text-sm text-amber-700 bg-amber-50 dark:bg-amber-950/30 dark:text-amber-400 rounded-lg border border-amber-200 dark:border-amber-900">
        âš ï¸ Sesja wygasÅ‚a. Zaloguj siÄ™ ponownie.
      </div>
    )}

    <!-- Login Form -->
    <LoginForm client:load redirectTo={redirectTo} />
  </div>
</AuthLayout>

